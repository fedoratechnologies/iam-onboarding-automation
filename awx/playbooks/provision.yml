---
- name: Provision HTHS students
  hosts: dc01.fedora.solutions
  gather_facts: false

  vars_files:
    - hths.yml

  tasks:
    - name: Fail if no students were provided
      ansible.builtin.fail:
        msg: "No students provided via extra_vars"
      when: students is not defined or students | length == 0
  
    - name: Debug loaded domain
      ansible.builtin.debug:
        var: ad_domain

    - name: Create HTHS student accounts in Active Directory
      microsoft.ad.user:
        name: "{{ item.first_name }} {{ item.last_name }}"
        sam_account_name: "{{ item.username[:20] }}"
        upn: "{{ item.username }}@{{ ad_domain }}"
        firstname: "{{ item.first_name }}"
        lastname: "{{ item.last_name }}"
        display_name: "{{ item.first_name }} {{ item.last_name }}"
        path: "{{ students_ou }}"
        password: "{{ temp_password }}"
        enabled: true
        password_expired: true
        password_never_expires: false

        # ✅ Store school email in AD (mail attribute)
        email: "{{ item.email }}"

        # ✅ Correct way to add proxyAddresses (module-safe)
        attributes:
          add:
            proxyAddresses:
              - "SMTP:{{ item.email }}"

        state: present
      loop: "{{ students }}"
      loop_control:
        label: "{{ item.username }}"

    - name: Ensure grade security groups exist
      microsoft.ad.group:
        name: "{{ item }}"
        path: "{{ groups_ou }}"
        scope: global
        category: security
        state: present
      loop: "{{ grade_groups.values() | unique }}"

    - name: Add students to grade security group
      microsoft.ad.group:
        name: "{{ grade_groups[item.cohort] }}"
        path: "{{ groups_ou }}"
        members:
          add:
            - "{{ item.username[:20] }}"
        state: present
      loop: "{{ students }}"
      loop_control:
        label: "{{ item.username }}"
