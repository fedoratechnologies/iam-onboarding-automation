---
- name: Provision HTHS students
  hosts: dc01.fedora.solutions
  gather_facts: false

  vars_files:
    - hths.yml

  pre_tasks:
    - name: Assert students were passed in via extra_vars
      ansible.builtin.assert:
        that:
          - students is defined
          - students | length > 0
        fail_msg: "No students provided via extra_vars"
      tags: [always]

    - name: Debug incoming students (temporary â€“ remove later)
      ansible.builtin.debug:
        var: students
      tags: [always]

  tasks:
    - name: Create HTHS student accounts in Active Directory
      microsoft.ad.user:
        name: "{{ item.first_name }} {{ item.last_name }}"
        sam_account_name: "{{ item.username }}"
        upn: "{{ item.username }}@{{ ad_domain }}"
        firstname: "{{ item.first_name }}"
        lastname: "{{ item.last_name }}"
        display_name: "{{ item.first_name }} {{ item.last_name }}"
        email: "{{ item.email }}"
        path: "{{ students_ou }}"
        password: "{{ temp_password }}"
        enabled: true
        password_expired: true
        password_never_expires: false
        state: present
      loop: "{{ students }}"
      loop_control:
        label: "{{ item.username }}"
      tags: [users]

    - name: Ensure grade security groups exist
      microsoft.ad.group:
        name: "{{ item.value }}"
        scope: global
        category: security
        path: "OU=Groups,OU=HolyTrinityHS,OU=Clients,DC=fedora,DC=solutions"
        state: present
      loop: "{{ grade_groups | dict2items }}"
      loop_control:
        label: "{{ item.value }}"
      tags: [groups]

    - name: Add students to grade security group
      microsoft.ad.group:
        name: "{{ grade_groups[item.cohort] }}"
        path: "OU=Groups,OU=HolyTrinityHS,OU=Clients,DC=fedora,DC=solutions"
        members:
          add:
            - "{{ item.username }}"
        state: present
      loop: "{{ students }}"
      loop_control:
        label: "{{ item.username }}"
      tags: [groups]
